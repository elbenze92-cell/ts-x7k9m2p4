name: Auto Bump Tampermonkey Versions

on:
  push:
    branches: [ main, master ]
    paths:
      - '**/*.user.js'  # ğŸ”¥ í•˜ìœ„ í´ë” í¬í•¨

jobs:
  bump-version:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # ğŸ”¥ ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
      
      - name: Check if triggered by bot
        id: check-author
        run: |
          LAST_AUTHOR=$(git log -1 --pretty=format:'%an')
          echo "last_author=$LAST_AUTHOR" >> $GITHUB_OUTPUT
          
          if [ "$LAST_AUTHOR" = "GitHub Actions Bot" ]; then
            echo "is_bot=true" >> $GITHUB_OUTPUT
          else
            echo "is_bot=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Auto bump version
        if: steps.check-author.outputs.is_bot != 'true'
        run: |
          echo "ğŸ”¢ ë²„ì „ ìë™ ì¦ê°€ ì‹œì‘..."
          echo ""
          
          changed_files=$(git diff-tree --no-commit-id --name-only -r HEAD | grep '\.user\.js$' || true)
          
          if [ -z "$changed_files" ]; then
            echo "âš ï¸ ë³€ê²½ëœ .user.js íŒŒì¼ ì—†ìŒ"
            exit 0
          fi
          
          for file in $changed_files; do
            if [ -f "$file" ]; then
              echo "ğŸ“ ì²˜ë¦¬ ì¤‘: $file"
              
              current_version=$(grep -oP '@version\s+\K[0-9]+\.[0-9]+\.[0-9]+' "$file" | head -1)
              
              if [ -z "$current_version" ]; then
                echo "   âš ï¸ @version íƒœê·¸ ì—†ìŒ, ê±´ë„ˆëœ€"
                echo ""
                continue
              fi
              
              IFS='.' read -r major minor patch <<< "$current_version"
              
              patch=$((patch + 1))
              
              if [ $patch -ge 10 ]; then
                patch=0
                minor=$((minor + 1))
              fi
              
              if [ $minor -ge 10 ]; then
                minor=0
                major=$((major + 1))
              fi
              
              new_version="$major.$minor.$patch"
              
              echo "   ğŸ“Œ $current_version â†’ $new_version"
              
              # ğŸ”¥ sed ëª…ë ¹ì–´ ê°œì„  (ê³µë°± ìœ ì§€)
              if [[ "$OSTYPE" == "darwin"* ]]; then
                # macOS
                sed -i '' "s/@version[[:space:]]*$current_version/@version      $new_version/" "$file"
              else
                # Linux
                sed -i "s/@version[[:space:]]*$current_version/@version      $new_version/" "$file"
              fi
              
              echo "   âœ… ì™„ë£Œ"
              echo ""
            fi
          done
          
          echo "âœ… ë²„ì „ ì¦ê°€ ì™„ë£Œ!"
      
      - name: Commit changes
        if: steps.check-author.outputs.is_bot != 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # ğŸ”¥ ë³€ê²½ëœ .user.js íŒŒì¼ë§Œ add
          git add '*.user.js' || true
          git add '**/*.user.js' || true
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ ì—†ìŒ (ë²„ì „ì´ ì´ë¯¸ ìµœì‹ ì´ê±°ë‚˜ @version íƒœê·¸ ì—†ìŒ)"
          else
            git commit -m "chore: auto bump versions [skip ci]"
            git push
            echo "âœ… ë³€ê²½ì‚¬í•­ í‘¸ì‹œ ì™„ë£Œ!"
          fi
      
      - name: Summary
        if: steps.check-author.outputs.is_bot != 'true'
        run: |
          echo "### ğŸ‰ ìë™ ë²„ì „ ì—…ë°ì´íŠ¸ ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ì—…ë°ì´íŠ¸ëœ íŒŒì¼:**" >> $GITHUB_STEP_SUMMARY
          
          # ğŸ”¥ í•˜ìœ„ í´ë” í¬í•¨ ê²€ìƒ‰
          find . -name "*.user.js" -type f | while read file; do
            if [ -f "$file" ]; then
              version=$(grep -oP '@version\s+\K[0-9]+\.[0-9]+\.[0-9]+' "$file" | head -1)
              echo "- \`$file\`: v$version" >> $GITHUB_STEP_SUMMARY
            fi
          done